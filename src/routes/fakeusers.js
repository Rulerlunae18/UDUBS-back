// backend/src/routes/fakeusers.js
const express = require('express');
const prisma = require('../utils/prisma');
const router = express.Router();

// –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω
const ADMIN_USER_ID = 1;

// –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä–æ–≤—ã–µ —Å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ RealUser
async function getLatestStatsForRealUser(realUser) {
  if (!realUser || !realUser.password) return null;

  return prisma.gameProfile.findFirst({
    where: { playerId: realUser.password }, // üîë UUID –∏–∑ Ren'Py
    orderBy: { collected_at: 'desc' },
  });
}


// === helpers for dynamic bio from GameProfile ===
function formatPlaytime(seconds) {
  const totalMinutes = Math.floor((seconds || 0) / 60);
  if (totalMinutes <= 0) return '–º–µ–Ω—å—à–µ —á–∞—Å–∞ –≤ —Å–∏—Å—Ç–µ–º–µ';

  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;

  if (hours && minutes) return `${hours} —á ${minutes} –º–∏–Ω –≤ —Å–∏—Å—Ç–µ–º–µ`;
  if (hours) return `${hours} —á –≤ —Å–∏—Å—Ç–µ–º–µ`;
  return `${minutes} –º–∏–Ω –≤ —Å–∏—Å—Ç–µ–º–µ`;
}

function humanLang(code) {
  switch ((code || '').toLowerCase()) {
    case 'uk':
      return '—É–∫—Ä–∞–∏–Ω—Å–∫–∏–π';
    case 'ru':
      return '—Ä—É—Å—Å–∫–∏–π';
    case 'en':
      return '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π';
    case 'ja':
      return '—è–ø–æ–Ω—Å–∫–∏–π';
    case 'de':
      return '–Ω–µ–º–µ—Ü–∫–∏–π';
    default:
      return `—è–∑—ã–∫: ${code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}`;
  }
}

function generateDynamicBio(stats) {
  if (!stats) {
    return 'Autogenerated field operator.';
  }

  // === –í–†–ï–ú–Ø –ò–ì–†–´ ===
  const play = formatPlaytime(stats.total_playtime || 0);

  // === –Ø–ó–´–ö –°–ò–°–¢–ï–ú–´ ===
  const lang = humanLang(stats.system_lang);

  // === –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–ï ===
  const country = stats.country || '–Ω–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã';
  const city = stats.city ? `, ${stats.city}` : '';

  // === SAFE MODE ===
  const safe = stats.safe_mode
    ? 'SAFE-—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω.'
    : 'SAFE-—Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á—ë–Ω.';

  // === –î–†–£–ì–ò–ï –ú–ï–¢–†–ò–ö–ò ===
  const kassi = stats.kassi_named ? 'Kassi: —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ –∫–æ–Ω—Ç–∞–∫—Ç.' : 'Kassi: –µ—â—ë –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞.';
  const scarlett = stats.scarlett_taunts > 0
    ? `Scarlett –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ ${stats.scarlett_taunts} —Ä–∞–∑.`
    : 'Scarlett –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ—è–≤–ª—è–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.';
  const silvair = stats.silvair_rickroll > 0
    ? `Silvair Rickroll: ${stats.silvair_rickroll} —Ä–∞–∑.`
    : 'Silvair –ø–æ–∫–∞ –Ω–µ –≤–º–µ—à–∏–≤–∞–ª—Å—è.';

  // === –§–ò–ù–ê–õ–¨–ù–û–ï BIO ===
  return `
–°—Ç–∞–∂ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${play}.
–õ–æ–∫–∞—Ü–∏—è: ${country}${city}.
–°–∏—Å—Ç–µ–º–Ω—ã–π —è–∑—ã–∫: ${lang}.
${safe}
  `.trim();
}

/* =======================================================
   üìå –ü–æ–ª—É—á–∏—Ç—å –í–°–ï–• –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π (—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–¥–º–µ–Ω–æ–π)
   ======================================================= */
router.get('/', async (req, res) => {
  try {
    const session = req.session?.user || null;

    const loggedUserId = session?.id || null;          // User.id
    const realUserId   = session?.realUser?.id || null; // RealUser.id
    const role         = session?.role || null;

    const fakeUsers = await prisma.fakeUser.findMany({
      orderBy: { id: 'asc' },
      include: { user: true },
    });

    // –ê–¥–º–∏–Ω ‚Äî –≤–∏–¥–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ FakeUser
    if (role === 'ADMIN') {
      return res.json(fakeUsers);
    }

    // –ò–≥—Ä–æ–∫ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥–º–µ–Ω—É –¢–û–õ–¨–ö–û –¥–ª—è —Å–≤–æ–µ–≥–æ —Å–ª–æ—Ç–∞
    const result = await Promise.all(
      fakeUsers.map(async fu => {
        if (fu.userId !== loggedUserId) {
          return fu; // NPC –∏ —Å–ª–æ—Ç –∞–¥–º–∏–Ω–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        }

        // –∑–∞–≥—Ä—É–∂–∞–µ–º realUser –∏–≥—Ä–æ–∫–∞
        const ru = await prisma.realUser.findUnique({
          where: { id: realUserId }
        });

        if (!ru) return fu;

        const latestStats = await getLatestStatsForRealUser(ru);
        console.log("üî• STATS –í FAKEUSERS:", latestStats?.total_playtime, latestStats);

        return {
          ...fu,
          codename: ru.username,
          avatarUrl: ru.avatarUrl || fu.avatarUrl,
          rank: 'Operator',
          clearance: 'D-13',
          bio: generateDynamicBio(latestStats)
        };
      })
    );

    return res.json(result);

  } catch (err) {
    console.error('FakeUsers list error:', err);
    return res.status(500).json({ error: 'Failed to load fake users' });
  }
});


/* =======================================================
   üìå –ü–æ–ª—É—á–∏—Ç—å –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è
   ======================================================= */
router.get('/:id', async (req, res) => {
  try {
    const id = Number(req.params.id);
    const session = req.session?.user || null;

    const loggedUserId = session?.id || null;         
    const realUserId   = session?.realUser?.id || null; 
    const role         = session?.role || null;

    let fu = await prisma.fakeUser.findUnique({
      where: { id },
      include: {
        user: true,
        posts: { orderBy: { createdAt: 'desc' } }
      },
    });

    if (!fu) return res.status(404).json({ error: 'Researcher not found' });

    // –ê–¥–º–∏–Ω: –æ—Ä–∏–≥–∏–Ω–∞–ª
    if (role === 'ADMIN') return res.json(fu);

    // –ü–æ–¥–º–µ–Ω–∞ –¥–ª—è —Å–ª–æ—Ç–∞ –∏–≥—Ä–æ–∫–∞
    if (fu.userId === loggedUserId) {
      const ru = await prisma.realUser.findUnique({
        where: { id: realUserId }
      });

      if (ru) {
        const latestStats = await getLatestStatsForRealUser(ru);
        console.log("üî• STATS –í FAKEUSERS:", latestStats?.total_playtime, latestStats);

        fu = {
          ...fu,
          codename: ru.username,
          avatarUrl: ru.avatarUrl || fu.avatarUrl,
          rank: 'Operator',
          clearance: 'D-13',
          bio: generateDynamicBio(latestStats)
        };
      }
    }

    return res.json(fu);

  } catch (err) {
    console.error('FakeUser profile error:', err);
    return res.status(500).json({ error: 'Failed to load researcher' });
  }
});


/* =======================================================
   üìå –ü–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ø–æ–¥–º–µ–Ω–æ–π –∞–≤—Ç–æ—Ä–∞)
   ======================================================= */
router.get('/:id/posts', async (req, res) => {
  try {
    const id = Number(req.params.id);
    const session = req.session?.user || null;

    const loggedUserId = session?.id || null;
    const realUserId   = session?.realUser?.id || null;
    const role         = session?.role || null;

    const fu = await prisma.fakeUser.findUnique({
      where: { id },
      include: { user: true }
    });

    if (!fu) return res.status(404).json({ error: 'Researcher not found' });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
    let posts = await prisma.post.findMany({
      where: { fakeAuthorId: fu.id },
      orderBy: { createdAt: 'desc' },
      include: { fakeAuthor: true }
    });

    // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å—ë –∫–∞–∫ –µ—Å—Ç—å
    if (role === 'ADMIN') {
      return res.json({ posts });
    }

    // –ò–≥—Ä–æ–∫: –ø–æ–¥–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∞ –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ FakeUser
    if (fu.userId === loggedUserId) {
      const ru = await prisma.realUser.findUnique({
        where: { id: realUserId }
      });

      if (ru) {
        const latestStats = await getLatestStatsForRealUser(ru);
        console.log("üî• STATS –í FAKEUSER POSTS:", latestStats?.total_playtime, latestStats);

        posts = posts.map(p => ({
          ...p,
          fakeAuthor: {
            ...p.fakeAuthor,
            codename: ru.username,
            avatarUrl: ru.avatarUrl || p.fakeAuthor.avatarUrl,
            rank: 'Operator',
            clearance: 'D-13',
            bio: generateDynamicBio(latestStats)
          }
        }));
      }
    }

    return res.json({ posts });

  } catch (err) {
    console.error('FakeUser posts error:', err);
    return res.status(500).json({ error: 'Failed to load posts' });
  }
});

module.exports = router;
